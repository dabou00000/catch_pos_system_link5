<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>اختبار كلمة سر مسح البيانات</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 2.5em;
        }
        .test-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            border-left: 5px solid #007bff;
        }
        .test-section h3 {
            color: #007bff;
            margin-top: 0;
        }
        .test-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .test-btn {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            border: none;
            padding: 15px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .test-btn:hover {
            background: linear-gradient(135deg, #0056b3 0%, #004085 100%);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,123,255,0.3);
        }
        .test-btn:active {
            transform: translateY(0);
        }
        .test-btn i {
            font-size: 18px;
        }
        .danger-btn {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }
        .danger-btn:hover {
            background: linear-gradient(135deg, #c82333 0%, #bd2130 100%);
            box-shadow: 0 5px 15px rgba(220,53,69,0.3);
        }
        .warning-btn {
            background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
        }
        .warning-btn:hover {
            background: linear-gradient(135deg, #f7931e 0%, #ff6b35 100%);
            box-shadow: 0 5px 15px rgba(255,107,53,0.3);
        }
        .info-box {
            background: #e7f3ff;
            border: 1px solid #b3d9ff;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        .info-box h4 {
            color: #0056b3;
            margin-top: 0;
        }
        .warning-box {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        .warning-box h4 {
            color: #856404;
            margin-top: 0;
        }
        .password-info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        .password-info h4 {
            color: #0c5460;
            margin-top: 0;
        }
        .results {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            border: 1px solid #dee2e6;
        }
        .results h4 {
            color: #495057;
            margin-top: 0;
        }
        .success {
            color: #28a745;
            font-weight: bold;
        }
        .error {
            color: #dc3545;
            font-weight: bold;
        }
        .warning {
            color: #ffc107;
            font-weight: bold;
        }
        .test-steps {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .test-steps h4 {
            color: #495057;
            margin-top: 0;
        }
        .test-steps ol {
            margin: 0;
            padding-right: 20px;
        }
        .test-steps li {
            margin: 10px 0;
            line-height: 1.6;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <h1><i class="fas fa-shield-alt"></i> اختبار كلمة سر مسح البيانات</h1>
        
        <div class="password-info">
            <h4><i class="fas fa-key"></i> كلمة السر المطلوبة</h4>
            <p><strong>كلمة السر:</strong> <code style="background: #f8f9fa; padding: 5px 10px; border-radius: 4px; font-size: 18px; font-weight: bold;">USER</code></p>
            <p>زر "مسح جميع البيانات" يتطلب إدخال هذه الكلمة قبل تنفيذ عملية المسح.</p>
        </div>

        <div class="warning-box">
            <h4><i class="fas fa-exclamation-triangle"></i> تحذير مهم</h4>
            <p><strong>هذا الاختبار سيحذف جميع البيانات التشغيلية!</strong></p>
            <p>سيتم حذف: المنتجات، العملاء، الموردين، المبيعات، المشتريات، التقارير، إلخ.</p>
            <p><strong>سيتم الاحتفاظ بـ:</strong> إعدادات النظام، الترخيص، المستخدم المسجل دخول.</p>
        </div>

        <div class="test-steps">
            <h4><i class="fas fa-list-ol"></i> خطوات الاختبار</h4>
            <ol>
                <li>اضغط على "اختبار كلمة سر صحيحة (USER)"</li>
                <li>ستظهر نافذة طلب كلمة السر</li>
                <li>أدخل كلمة السر: <strong>USER</strong></li>
                <li>ستظهر رسالة تأكيد المسح</li>
                <li>اضغط "موافق" للمتابعة</li>
                <li>ستظهر رسالة النجاح</li>
            </ol>
        </div>

        <div class="test-section">
            <h3><i class="fas fa-vial"></i> اختبار كلمة السر</h3>
            <div class="test-buttons">
                <button class="test-btn" onclick="testPassword('USER')" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
                    <i class="fas fa-check"></i>
                    اختبار كلمة سر صحيحة (USER)
                </button>
                <button class="test-btn" onclick="testPassword('user')" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);">
                    <i class="fas fa-times"></i>
                    اختبار كلمة سر خاطئة (user)
                </button>
                <button class="test-btn" onclick="testPassword('123')" style="background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%); color: #212529;">
                    <i class="fas fa-exclamation"></i>
                    اختبار كلمة سر خاطئة (123)
                </button>
                <button class="test-btn" onclick="testPassword('')" style="background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);">
                    <i class="fas fa-ban"></i>
                    اختبار إلغاء (بدون إدخال)
                </button>
            </div>
        </div>

        <div class="test-section">
            <h3><i class="fas fa-database"></i> اختبار زر مسح البيانات الفعلي</h3>
            <div class="test-buttons">
                <button class="test-btn warning-btn" onclick="testClearDataButton()">
                    <i class="fas fa-trash-alt"></i>
                    اختبار زر مسح البيانات الفعلي
                </button>
                <button class="test-btn" onclick="addSampleData()">
                    <i class="fas fa-plus"></i>
                    إضافة بيانات تجريبية
                </button>
            </div>
        </div>

        <div class="results">
            <h4><i class="fas fa-clipboard-list"></i> نتائج الاختبار</h4>
            <div id="testResults">
                <p>لم يتم إجراء أي اختبارات بعد.</p>
            </div>
        </div>

        <div class="info-box">
            <h4><i class="fas fa-info-circle"></i> معلومات إضافية</h4>
            <ul>
                <li><strong>كلمة السر:</strong> USER (أحرف كبيرة)</li>
                <li><strong>الوظيفة:</strong> حماية زر مسح جميع البيانات</li>
                <li><strong>الرسائل:</strong> تظهر بالعربية والإنجليزية حسب إعدادات اللغة</li>
                <li><strong>الأمان:</strong> يمنع الوصول غير المصرح به لمسح البيانات</li>
            </ul>
        </div>
    </div>

    <script>
        let testResults = [];
        
        // دالة مسح جميع البيانات (نسخة من script.js)
        function clearAllOperationalData() {
            const currentLang = document.documentElement.lang || localStorage.getItem('appLanguage') || 'ar';
            const isEn = currentLang === 'en';
            
            // طلب كلمة السر أولاً
            const passwordPrompt = isEn 
                ? 'Enter password to clear all data:'
                : 'أدخل كلمة السر لمسح جميع البيانات:';
            
            const enteredPassword = prompt(passwordPrompt);
            
            // التحقق من كلمة السر
            if (enteredPassword !== 'USER') {
                const errorMsg = isEn 
                    ? '❌ Incorrect password. Access denied.'
                    : '❌ كلمة السر غير صحيحة. تم رفض الوصول.';
                showMessage(errorMsg, 'error');
                return;
            }
            
            // طلب تأكيد من المستخدم
            const confirmMessage = isEn 
                ? '⚠️ WARNING: This will delete ALL operational data (sales, customers, suppliers, invoices, reports, etc.) while keeping system settings and license intact.\n\nAre you sure you want to continue?'
                : '⚠️ تحذير: سيتم حذف جميع البيانات التشغيلية (المبيعات، العملاء، الموردين، الفواتير، التقارير، إلخ) مع الاحتفاظ بإعدادات النظام والترخيص.\n\nهل أنت متأكد من المتابعة؟';
            
            if (!confirm(confirmMessage)) {
                const result = {
                    action: 'مسح البيانات',
                    result: 'CANCELLED',
                    timestamp: new Date().toLocaleString(),
                    details: 'تم إلغاء العملية من قبل المستخدم'
                };
                testResults.push(result);
                updateResults();
                return;
            }
            
            try {
                console.log('🧹 بدء مسح البيانات التشغيلية...');
                
                const operationalKeys = [
                    'products', 'customers', 'sales', 'suppliers', 'purchases',
                    'supplierPayments', 'purchaseReturns', 'supplierLedger',
                    'stockMovements', 'salesLogs', 'customerLogs', 'cart',
                    'lastCartFocusIndex', 'profit.pageSize', 'capital.pageSize',
                    'lastWarningTime'
                ];
                
                let clearedCount = 0;
                operationalKeys.forEach(key => {
                    try {
                        localStorage.removeItem(key);
                        clearedCount++;
                        console.log(`✅ تم مسح: ${key}`);
                    } catch (e) {
                        console.warn(`⚠️ فشل في مسح: ${key}`, e);
                    }
                });
                
                // إعادة تعيين الصندوق
                const cashDrawer = {
                    cashUSD: 100.00,
                    cashLBP: 0,
                    transactions: [],
                    lastUpdate: new Date().toISOString()
                };
                localStorage.setItem('cashDrawer', JSON.stringify(cashDrawer));
                
                const successMessage = isEn 
                    ? `✅ All operational data cleared successfully!\n\nCleared ${clearedCount} data sets.\nSystem settings and license preserved.`
                    : `✅ تم مسح جميع البيانات التشغيلية بنجاح!\n\nتم مسح ${clearedCount} مجموعة بيانات.\nتم الاحتفاظ بإعدادات النظام والترخيص.`;
                
                showMessage(successMessage, 'success');
                
                const result = {
                    action: 'مسح البيانات',
                    result: 'SUCCESS',
                    timestamp: new Date().toLocaleString(),
                    details: `تم مسح ${clearedCount} مجموعة بيانات`
                };
                testResults.push(result);
                updateResults();
                
            } catch (error) {
                console.error('❌ خطأ في مسح البيانات:', error);
                const errorMessage = isEn 
                    ? '❌ Error occurred while clearing data. Please try again.'
                    : '❌ حدث خطأ أثناء مسح البيانات. يرجى المحاولة مرة أخرى.';
                showMessage(errorMessage, 'error');
                
                const result = {
                    action: 'مسح البيانات',
                    result: 'FAILED',
                    timestamp: new Date().toLocaleString(),
                    details: error.message
                };
                testResults.push(result);
                updateResults();
            }
        }
        
        function testPassword(password) {
            console.log(`Testing password: ${password}`);
            
            // محاكاة إدخال كلمة السر
            const originalPrompt = window.prompt;
            window.prompt = function(message) {
                return password;
            };
            
            const result = clearAllOperationalData();
            
            // استعادة الدالة الأصلية
            window.prompt = originalPrompt;
            
            const testResult = {
                action: 'اختبار كلمة السر',
                password: password || '(empty)',
                result: password === 'USER' ? 'SUCCESS' : 'FAILED',
                timestamp: new Date().toLocaleString(),
                details: password === 'USER' ? 'كلمة السر صحيحة' : 'كلمة السر خاطئة'
            };
            testResults.push(testResult);
            updateResults();
        }
        
        function testClearDataButton() {
            console.log('Testing clear data button...');
            const result = clearAllOperationalData();
        }
        
        function addSampleData() {
            try {
                console.log('إضافة بيانات تجريبية...');
                
                // إضافة منتجات تجريبية
                const sampleProducts = [
                    { id: 1, name: 'منتج تجريبي 1', priceUSD: 10, stock: 50, minStock: 5 },
                    { id: 2, name: 'منتج تجريبي 2', priceUSD: 20, stock: 30, minStock: 3 },
                    { id: 3, name: 'منتج تجريبي 3', priceUSD: 15, stock: 25, minStock: 2 }
                ];
                localStorage.setItem('products', JSON.stringify(sampleProducts));
                
                // إضافة عملاء تجريبيين
                const sampleCustomers = [
                    { id: 1, name: 'عميل تجريبي 1', phone: '0123456789', totalPurchases: 100 },
                    { id: 2, name: 'عميل تجريبي 2', phone: '0987654321', totalPurchases: 200 }
                ];
                localStorage.setItem('customers', JSON.stringify(sampleCustomers));
                
                // إضافة مبيعات تجريبية
                const sampleSales = [
                    { id: 1, date: new Date().toISOString(), amount: 50, customer: 'عميل تجريبي 1' },
                    { id: 2, date: new Date().toISOString(), amount: 75, customer: 'عميل تجريبي 2' }
                ];
                localStorage.setItem('sales', JSON.stringify(sampleSales));
                
                const result = {
                    action: 'إضافة بيانات تجريبية',
                    result: 'SUCCESS',
                    timestamp: new Date().toLocaleString(),
                    details: 'تم إضافة بيانات تجريبية بنجاح'
                };
                testResults.push(result);
                updateResults();
                
                showMessage('✅ تم إضافة البيانات التجريبية بنجاح!', 'success');
                
            } catch (error) {
                console.error('خطأ في إضافة البيانات التجريبية:', error);
                const result = {
                    action: 'إضافة بيانات تجريبية',
                    result: 'FAILED',
                    timestamp: new Date().toLocaleString(),
                    details: error.message
                };
                testResults.push(result);
                updateResults();
                showMessage('❌ فشل في إضافة البيانات التجريبية', 'error');
            }
        }
        
        function showMessage(message, type) {
            console.log(`[${type.toUpperCase()}] ${message}`);
            alert(message);
        }
        
        function updateResults() {
            const resultsDiv = document.getElementById('testResults');
            if (testResults.length === 0) {
                resultsDiv.innerHTML = '<p>لم يتم إجراء أي اختبارات بعد.</p>';
                return;
            }
            
            let html = '<table style="width: 100%; border-collapse: collapse;">';
            html += '<thead><tr style="background: #f8f9fa;">';
            html += '<th style="border: 1px solid #dee2e6; padding: 10px;">الإجراء</th>';
            html += '<th style="border: 1px solid #dee2e6; padding: 10px;">كلمة السر</th>';
            html += '<th style="border: 1px solid #dee2e6; padding: 10px;">النتيجة</th>';
            html += '<th style="border: 1px solid #dee2e6; padding: 10px;">التفاصيل</th>';
            html += '<th style="border: 1px solid #dee2e6; padding: 10px;">الوقت</th>';
            html += '</tr></thead><tbody>';
            
            testResults.forEach(result => {
                const resultClass = result.result === 'SUCCESS' ? 'success' : 
                                  result.result === 'FAILED' ? 'error' : 'warning';
                const resultIcon = result.result === 'SUCCESS' ? '✅' : 
                                 result.result === 'FAILED' ? '❌' : '⚠️';
                
                html += '<tr>';
                html += `<td style="border: 1px solid #dee2e6; padding: 10px;">${result.action}</td>`;
                html += `<td style="border: 1px solid #dee2e6; padding: 10px;">${result.password || '-'}</td>`;
                html += `<td style="border: 1px solid #dee2e6; padding: 10px;" class="${resultClass}">${resultIcon} ${result.result}</td>`;
                html += `<td style="border: 1px solid #dee2e6; padding: 10px;">${result.details}</td>`;
                html += `<td style="border: 1px solid #dee2e6; padding: 10px;">${result.timestamp}</td>`;
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            
            resultsDiv.innerHTML = html;
        }
        
        // تشغيل الاختبار التلقائي عند تحميل الصفحة
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Test page loaded successfully');
            console.log('Clear data password test ready');
        });
    </script>
</body>
</html>
